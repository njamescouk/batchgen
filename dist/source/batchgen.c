#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include "batchgen.h"
#include "stacks.h"
#include "sr.h"

#pragma warning( disable : 4996 )

char getopts (int argc, char *argv[]);
void set_flag(char *argv);
void make_banner(char *progname, char *fname, char *opts, char banner[BUFSIZ]);
void make_opts(char opts[BUFSIZ]);
int write_code(char *banner, FILE *uoofp);
int write_optim_code(char *banner, char **ca, FILE *oofp);

extern FILE *yyin;
extern int yydebug;

char optflag = 0;
code_list_t *cl = NULL;

int main (int argc, char *argv[])
{
    FILE *uoofp = NULL;
    char result = 0, 
         farg = 0;

    unlink ("bg.bat");

    farg = getopts (argc, argv);
    if (farg != 0)
        yyin = fopen (argv [farg], "rt");
    else
        yyin = stdin;

    if (yyin == NULL)
    {
       perror ("cannot open input file");
       return 1;
    }

    stack_init ();

#ifdef YYDEBUG
    yydebug = 1;
#endif

    if (yyparse () == 0)
    {
        char banner[BUFSIZ];
        char opts[BUFSIZ];
        code_list_t *mainjmp = new_code_node ();
        char filename[BUFSIZ];
        int i;

        strcpy (filename, (farg == 0 ? "stdin":argv[farg]));

        for (i = 0; i < num_sr; i++)
            cl = code_join (2, srcode [i], cl);

        add_string (mainjmp, "@goto main\n");
        cl = code_join (2, mainjmp, cl);

        make_opts(opts);
        make_banner(argv[0], 
                    filename,
                    opts,
                    banner);
        write_code(banner, uoofp);
   }
   else
   {
      result = 1;
   }

   if (yyin != NULL && yyin != stdin)
      fclose (yyin);

   return result;
}

char getopts (int argc, char *argv[])
{
   char i;
   char fname = 0;

   for (i = 0; i < argc; i++)
   {
      if (argv [i][0] == '-')
         set_flag(argv[i]);
      else if (fname == 0)
         fname = i;
   }

   return fname;
}

/*
    caller is sending us a string from the cmd line
    that is known to be an option.
    we find out what the option is and set flags
    or issue error messages accordingly.
*/
void set_flag(char *argv)
{
    switch (argv [1])
    {
    case 'h':   
        fprintf (stderr, "usage: %s [-o[r|b]] filename\n", argv[0]);
        exit (3);
    default: 
        fprintf (stderr, "unknown option -%c\n", argv [1]);
    break;
    }
}

void make_opts(char opts[BUFSIZ])
{
    opts[0] = 0;
}

void make_banner(char *progname, char *fname, char *opts, char banner[BUFSIZ])
{
    time_t timeNow;
    char szTime[BUFSIZ];
    struct tm *localTime = NULL;

    time(&timeNow);
    localTime = localtime(&timeNow);
    sprintf (szTime, 
             "%d-%d-%d %02d:%02d:%02d", 
             localTime->tm_year + 1900,
             localTime->tm_mon,
             localTime->tm_mday+1, /* yes, really. days start at 1, 
                                      months start at 0 */
             localTime->tm_hour,
             localTime->tm_min,
             localTime->tm_sec);

    banner[0] = 0;
    sprintf(banner,
          "@echo off\n"
          "rem this file has been generated by batchgen and may be overwritten\n"
          "rem command line: %s %s %s\n"
          "rem date %s\n\n",
          progname,
          opts,
          fname,
          szTime);
}

int write_code(char *banner, FILE *uoofp)
{
    uoofp = fopen ("bg.bat", "wt");
    if (uoofp == NULL)
    {
        fprintf (stderr, "unable to open unopt out file\n");
        return 1;
    }

    fprintf(uoofp, "%s", banner);
    emit (cl, uoofp);
    fclose (uoofp);

    return 0;
}

